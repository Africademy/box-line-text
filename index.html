<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="content-type"/>
<meta name=viewport content="width=device-width, initial-scale=1"/>
<title>Box Box Line</title>
<style>
html,body {
  height: 100%;
  width: 100%;
  font-size: 32px;
  font-family: Noto Sans CJK JP, arial;
  overflow:hidden;
  user-drag:none;
}
* {
  margin:0;
  padding:0;
  z-index:0;
}
figure {
  position:absolute;
  border: 2px solid #333;
  box-sizing: border-box;
  border-radius:10px;
}
figcaption {
  z-index:1;
  position:absolute;
  border:none;
  outline:none;
  font-size:32px;
  color: #333;
  padding:0 .5em;
  line-height:64px;
  height:64px;
  background-color: rgba(0,0,0,0);
}
</style>
</head>
<body>
<script>
let mousedown, dragstart, tmpbox

function snap(coords) {
  return [coords].flat().map(c => Math.round(c / 64) * 64)
}

function createCaption(p, parent=document.body) {
    let input = document.createElement('figcaption')
    ;[input.style.left, input.style.top] = snap(p).map(s => `${s}px`)
    input.contentEditable = 'true'
    
    parent.append(input)

    input.focus()

    return input
}

function createBox(p1, p2, tmp=false) {
    tmpbox && tmpbox.remove()
 
    let box = document.createElement('figure')

    ;[box.style.left, box.style.top] = snap([
      Math.min(p1[0], p2[0]),
      Math.min(p1[1], p2[1])
    ]).map(s => `${s}px`)
    let size = p1.map((s, i) => Math.abs(s - p2[i]))
    ;[box.style.width, box.style.height] = snap(size).map(s => `${s}px`)
    
    document.body.append(box)

    if (tmp) {
      tmpbox = box
    }
    
    createCaption([0,0], box)

    return box
}

document.body.addEventListener('mousedown', (e) => {
  if (e.target.tagName.toLowerCase() == 'figcaption') {
    return false
  }

  e.preventDefault()

  mousedown = true
  dragstart = [e.clientX, e.clientY]
})

document.body.addEventListener('mousemove', (e) => {
  if (mousedown) createBox([e.clientX, e.clientY], dragstart, tmp=true)
})

document.body.addEventListener('mouseup', (e) => {
  e.preventDefault()
  tmpbox && tmpbox.remove()

  if (!mousedown) return false
  mousedown = false

  let dragend = [e.clientX, e.clientY]

  if (dragend.every((p, i) => Math.abs(p - dragstart[i]) < 8 )) {
    if (e.target.tagName == 'FIGCAPTION') return false
    createCaption(dragend)
  } else {
    createBox(dragstart, dragend)
  }
})

document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key == 'z') document.querySelector('body>:last-child').remove()
});
</script>
</body>
</html>