<html>
<head>
<style>
body {
  height: 100%;
  width: 100%;
  font-size: 32px;
  font-family: Noto Sans CJK JP, arial;
  overflow:hidden;
  user-drag:none;
}
* {
  margin:0;
  padding:0;
}
figure {
  position:absolute;
  border: 2px solid #333;
  box-sizing: border-box;
  border-radius:10px;
}
figcaption {
  position:absolute;
  border:none;
  font-size:32px;
  color: #333;
  padding:0 .5em;
  line-height:64px;
  height:64px;
  background-color: rgba(0,0,0,0);
}
</style>
</head>
<body>

<script>
let mousedown

function snap(coords) {
  return [coords].flat().map(c => Math.round(c / 64) * 64)
}

document.body.addEventListener('mousedown', (e) => {
  if (e.target.tagName.toLowerCase() == 'figcaption') {
    mousedown = false
    return false
  }

  e.preventDefault()

  mousedown = [e.clientX, e.clientY]
})

function createCaption(x, y) {
    let input = document.createElement('figcaption')
    input.style.left = snap(x)
    input.style.top = snap(y)
    input.contentEditable = 'true'
    
    document.body.append(input)

    input.focus()
}

document.body.addEventListener('mouseup', (e) => {
  e.preventDefault()

  if (e.target.tagName.toLowerCase() == 'figcaption' || !mousedown) {
    return false
  }
  
  if ([e.clientX, e.clientY].every((p, i) => Math.abs(p - mousedown[i]) < 50 )) {
    createCaption(e.clientX, e.clientY)
  } else {
    let box = document.createElement('figure')

    ;[box.style.left, box.style.top] = snap([
      Math.min(mousedown[0], e.clientX),
      Math.min(mousedown[1], e.clientY)
    ])
    let size = [e.clientX, e.clientY].map((p, i) => Math.abs(p - mousedown[i]))  
    ;[box.style.width, box.style.height] = snap(size)
    
    document.body.prepend(box)
  }
})
</script>
</body>
</html>